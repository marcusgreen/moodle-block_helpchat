{"version":3,"file":"form_integration.min.js","sources":["../src/form_integration.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Moodle form integration for DOM parser\n *\n * @module     block_ai_chat/form_integration\n * @copyright  2025 ISB Bayern\n * @author     Dr. Peter Mayer\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {populateHiddenField, autoPopulateHiddenField } from './dom_parser';\n\n/**\n * Initialize form integration with DOM parser\n *\n * @param {string} hiddenFieldId - ID of the hidden field to populate\n * @param {Object} options - Configuration options for DOM parser\n * @param {number} debounceMs - Debounce time for auto-population (default: 1000ms)\n */\nexport const initFormIntegration = (hiddenFieldId, options = {}, debounceMs = 1000) => {\n    // Ensure DOM parser is available\n    if (typeof window.MoodleDomParser === 'undefined') {\n        console.warn('DOM Parser not available, loading...');\n        // Try to load it dynamically\n     import('./dom_parser.js').then(({ makeGloballyAccessible }) => {\n            makeGloballyAccessible();\n            setupIntegration(hiddenFieldId, options, debounceMs);\n        }).catch(error => {\n            console.error('Failed to load DOM parser:', error);\n        });\n    } else {\n        setupIntegration(hiddenFieldId, options, debounceMs);\n    }\n};\n\n/**\n * Setup the actual integration\n *\n * @param {string} hiddenFieldId\n * @param {Object} options\n * @param {number} debounceMs\n */\nconst setupIntegration = async (hiddenFieldId, options, debounceMs) => {\n    try {\n        // Initial population when form is ready\n        await populateHiddenField(hiddenFieldId, options);\n        console.log('Form integration initialized successfully');\n\n        // Setup auto-population for dynamic updates\n        const cleanup = autoPopulateHiddenField(hiddenFieldId, options, debounceMs);\n\n        // Store cleanup function for later use\n        window.M.block_ai_chat.cleanupFormIntegration = cleanup;\n\n        // Handle form submission\n        const form = document.querySelector('form.moodleform');\n        if (form) {\n            form.addEventListener('submit', async (e) => {\n                try {\n                    // Ensure hidden field is populated before submission\n                    await populateHiddenField(hiddenFieldId, options);\n                } catch (error) {\n                    console.error('Failed to populate hidden field before submission:', error);\n                    // Don't prevent submission, just log the error\n                }\n            });\n        }\n\n    } catch (error) {\n        console.error('Form integration setup failed:', error);\n    }\n};\n\n/**\n * Manual trigger to populate form analysis data\n *\n * @param {string} hiddenFieldId\n * @param {Object} options\n */\nexport const populateFormAnalysis = async (hiddenFieldId, options = {}) => {\n    try {\n        if (typeof window.MoodleDomParser === 'undefined') {\n            throw new Error('DOM Parser not available');\n        }\n\n        await populateHiddenField(hiddenFieldId, options);\n        console.log('Form analysis data populated manually');\n\n        return true;\n    } catch (error) {\n        console.error('Manual form analysis failed:', error);\n        return false;\n    }\n};\n\n/**\n * Get current form analysis data\n *\n * @param {string} hiddenFieldId\n * @returns {Object|null} Parsed form analysis data or null if not available\n */\nexport const getCurrentFormAnalysis = (hiddenFieldId) => {\n    const hiddenField = document.getElementById(hiddenFieldId);\n    if (!hiddenField || !hiddenField.value) {\n        return null;\n    }\n\n    try {\n        return JSON.parse(hiddenField.value);\n    } catch (error) {\n        console.error('Failed to parse form analysis data:', error);\n        return null;\n    }\n};\n\n/**\n * Get summary of current form state\n *\n * @param {string} hiddenFieldId\n * @returns {Object|null} Form summary or null if not available\n */\nexport const getFormSummary = (hiddenFieldId) => {\n    const analysis = getCurrentFormAnalysis(hiddenFieldId);\n    if (!analysis || !analysis.elements) {\n        return null;\n    }\n\n    const elements = analysis.elements;\n\n    return {\n        timestamp: analysis.timestamp,\n        totalElements: elements.length,\n        filledElements: elements.filter(el => el.current_value && el.current_value.trim() !== '').length,\n        visibleElements: elements.filter(el => el.visible === 1).length,\n        hiddenElements: elements.filter(el => el.visible === 0).length,\n        formUrl: analysis.formUrl,\n        elementTypes: {\n            text: elements.filter(el => ['text', 'email', 'password'].includes(el.type)).length,\n            select: elements.filter(el => el.type === 'select').length,\n            textarea: elements.filter(el => el.type === 'textarea').length,\n            checkbox: elements.filter(el => el.type === 'checkbox').length,\n            radio: elements.filter(el => el.type === 'radio').length\n        }\n    };\n};\n\n// Initialize Moodle namespace if it doesn't exist\nif (typeof M.block_ai_chat === 'undefined') {\n    M.block_ai_chat = {};\n}\n\n// Export functions to Moodle namespace\nM.block_ai_chat.initFormIntegration = initFormIntegration;\nM.block_ai_chat.populateFormAnalysis = populateFormAnalysis;\nM.block_ai_chat.getCurrentFormAnalysis = getCurrentFormAnalysis;\nM.block_ai_chat.getFormSummary = getFormSummary;\n"],"names":["initFormIntegration","hiddenFieldId","options","debounceMs","window","MoodleDomParser","console","warn","then","_ref","makeGloballyAccessible","setupIntegration","catch","error","async","log","cleanup","M","block_ai_chat","cleanupFormIntegration","form","document","querySelector","addEventListener","populateFormAnalysis","Error","getCurrentFormAnalysis","hiddenField","getElementById","value","JSON","parse","getFormSummary","analysis","elements","timestamp","totalElements","length","filledElements","filter","el","current_value","trim","visibleElements","visible","hiddenElements","formUrl","elementTypes","text","includes","type","select","textarea","checkbox","radio"],"mappings":"8aAiCaA,oBAAsB,SAACC,mBAAeC,+DAAU,GAAIC,kEAAa,SAEpC,IAA3BC,OAAOC,iBACdC,QAAQC,KAAK,woBAEUC,MAAKC,WAACC,uBAAEA,6BAC3BA,yBACAC,iBAAiBV,cAAeC,QAASC,eAC1CS,OAAMC,QACLP,QAAQO,MAAM,6BAA8BA,WAGhDF,iBAAiBV,cAAeC,QAASC,oEAW3CQ,iBAAmBG,MAAOb,cAAeC,QAASC,wBAG1C,mCAAoBF,cAAeC,SACzCI,QAAQS,IAAI,mDAGNC,SAAU,uCAAwBf,cAAeC,QAASC,YAGhEC,OAAOa,EAAEC,cAAcC,uBAAyBH,cAG1CI,KAAOC,SAASC,cAAc,mBAChCF,MACAA,KAAKG,iBAAiB,UAAUT,MAAAA,cAGlB,mCAAoBb,cAAeC,SAC3C,MAAOW,OACLP,QAAQO,MAAM,qDAAsDA,WAMlF,MAAOA,OACLP,QAAQO,MAAM,iCAAkCA,SAU3CW,qBAAuBV,eAAOb,mBAAeC,+DAAU,eAEtB,IAA3BE,OAAOC,sBACR,IAAIoB,MAAM,yCAGd,mCAAoBxB,cAAeC,SACzCI,QAAQS,IAAI,0CAEL,EACT,MAAOF,cACLP,QAAQO,MAAM,+BAAgCA,QACvC,6DAUFa,uBAA0BzB,sBAC7B0B,YAAcN,SAASO,eAAe3B,mBACvC0B,cAAgBA,YAAYE,aACtB,gBAIAC,KAAKC,MAAMJ,YAAYE,OAChC,MAAOhB,cACLP,QAAQO,MAAM,sCAAuCA,OAC9C,oEAUFmB,eAAkB/B,sBACrBgC,SAAWP,uBAAuBzB,mBACnCgC,WAAaA,SAASC,gBAChB,WAGLA,SAAWD,SAASC,eAEnB,CACHC,UAAWF,SAASE,UACpBC,cAAeF,SAASG,OACxBC,eAAgBJ,SAASK,QAAOC,IAAMA,GAAGC,eAA6C,KAA5BD,GAAGC,cAAcC,SAAeL,OAC1FM,gBAAiBT,SAASK,QAAOC,IAAqB,IAAfA,GAAGI,UAAeP,OACzDQ,eAAgBX,SAASK,QAAOC,IAAqB,IAAfA,GAAGI,UAAeP,OACxDS,QAASb,SAASa,QAClBC,aAAc,CACVC,KAAMd,SAASK,QAAOC,IAAM,CAAC,OAAQ,QAAS,YAAYS,SAAST,GAAGU,QAAOb,OAC7Ec,OAAQjB,SAASK,QAAOC,IAAkB,WAAZA,GAAGU,OAAmBb,OACpDe,SAAUlB,SAASK,QAAOC,IAAkB,aAAZA,GAAGU,OAAqBb,OACxDgB,SAAUnB,SAASK,QAAOC,IAAkB,aAAZA,GAAGU,OAAqBb,OACxDiB,MAAOpB,SAASK,QAAOC,IAAkB,UAAZA,GAAGU,OAAkBb,sDAM/B,IAApBpB,EAAEC,gBACTD,EAAEC,cAAgB,IAItBD,EAAEC,cAAclB,oBAAsBA,oBACtCiB,EAAEC,cAAcM,qBAAuBA,qBACvCP,EAAEC,cAAcQ,uBAAyBA,uBACzCT,EAAEC,cAAcc,eAAiBA"}